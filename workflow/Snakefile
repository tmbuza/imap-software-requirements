from snakemake.utils import min_version

min_version("6.10.0")


# Configuration file containing all user-specified settings
configfile: "config/config.yaml"

# Function for aggregating list of raw sequencing files.
mothurSamples = list(set(glob_wildcards(os.path.join('data/mothur/raw/', '{sample}_{readNum, R[12]}_001.fastq.gz')).sample))

import os
import csv
import pandas as pd

# Get the SRA Run accessions
METADATA=pd.read_csv('config/SraRunTable.csv').loc[0:1]

ACCESSIONS=METADATA['Run'].tolist() # Specify the column containing the accession, in this demo is Run

OUTDIR="data/reads" 
if not os.path.exists(OUTDIR):
   os.makedirs(OUTDIR)

###############################################
###############################################


# Master rule for controlling workflow.
rule all:
    input:
        "index.html",
        # "project_tree.txt",
        # "data/metadata/metadata.csv",
        # "data/metadata/read_size_asce.csv",
        # "data/metadata/read_size_desc.csv",
        # "images/variable_freq.png",
        # "images/variable_freq.svg",
        # "images/sample_gps.png",
        # "images/smkreport/screenshot.png",  
        expand("{outdir}/{accession}_1.fastq", outdir=OUTDIR, accession=ACCESSIONS),
        expand("{outdir}/{accession}_2.fastq", outdir=OUTDIR, accession=ACCESSIONS),

# Get analysis software
rule basic_software:
    input:
        rmd="software.Rmd",
        ide="images/RStudioIDE.png"
    output:
        html="software.html"
    shell:
        """
        R -e "library(rmarkdown); render('{input.rmd}')"
        """


# Get tidy metadata
rule get_tidy_metadata:
    output:
        csv="data/metadata/metadata.csv"
    script:
        "scripts/get_tidy_metadata.R"
        

# Get variable barplot
rule plot_variable_freq:
    input:
        csv=rules.get_tidy_metadata.output.csv
    output:
        png="images/variable_freq.png",
        svg="images/variable_freq.svg"
    script:
        "scripts/plot_var_freq.R"


# Get read size
rule explore_read_size:
    input:
        csv=rules.get_tidy_metadata.output.csv
    output:
        asce="data/metadata/read_size_asce.csv",
        desc="data/metadata/read_size_desc.csv"
    script:
        "scripts/explore_read_size.R"
      

# Get sample location 
rule get_sample_gps:
    input:
        csv=rules.get_tidy_metadata.output.csv
    output:
        map="images/sample_gps.png"
    script:
        "scripts/get_sample_gps.R"


# Dowload the SRA RUN reads
rule download_sra_reads: 
    input:
        acc=rules.get_tidy_metadata.output.csv
    output:
        "{outdir}/{accession}_1.fastq",
        "{outdir}/{accession}_2.fastq"
    params:
        download_folder=OUTDIR,
    threads: 1
    shell:
        "fasterq-dump {wildcards.accession} -O {params.download_folder} --threads {threads}"


# Get directory tree
rule get_project_tree_txt:
    output:
        tree="project_tree.txt"
    shell:
        """
        tree -L 2 . >{output}
        """

# Get rule graphs
rule get_rulegraph:
    output:
        "dags/rulegraph.svg",
    shell:
        "bash workflow/scripts/rules_dag.sh"

# Get smk html report
rule snakemake_html_report:
    output:
        html="report.html"
    shell:
        """
        bash "workflow/scripts/snakemake_html_report.sh
        """

# Get static image of smk report
rule static_smk_report:
    input:
        html=rules.snakemake_html_report.output.html
    output:
        "images/smkreport/screenshot.png"
    shell:
        "bash workflow/scripts/interactive_report.sh"


# Create a shareabke html report
rule github_page_index:
    input:
        script="workflow/scripts/render.R",
        rmd="index.Rmd",
        rulegraph="dags/rulegraph.svg",
        dag=rules.plot_variable_freq.output,
        map=rules.get_sample_gps.output,
        smkstats=rules.static_smk_report.output,
        tree=rules.get_project_tree_txt.output,
        asce=rules.explore_read_size.output.asce,
        desc=rules.explore_read_size.output.desc,
    output:
        doc="index.html",
    shell:
        """
        R -e "library(rmarkdown); render('{input.rmd}')"
        """